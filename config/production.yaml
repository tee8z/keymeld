# KeyMeld Production Configuration
# ===============================
# This configuration requires dynamic CID assignment for AWS Nitro Enclaves

environment: production # Runtime environment (development/production) - enables strict security validation
server:
  host: "0.0.0.0" # Server bind address - 0.0.0.0 listens on all interfaces
  port: 443 # HTTPS server port (requires TLS termination via load balancer)
  enable_cors: false # Disable CORS in production (handled by load balancer/proxy)
  enable_compression: true # Enable HTTP response compression (gzip) for bandwidth efficiency
kms:
  enabled: true # Enable AWS KMS integration for secure key management
  endpoint_url: null # Use default AWS KMS endpoint (region-based)
  key_id: "${KMS_KEY_ARN}" # KMS key ARN from environment variable for enclave encryption
database:
  path: "/var/lib/keymeld/keymeld.db" # SQLite database file path (should be on persistent storage)
  max_connections: 50 # Maximum concurrent database connections in pool (higher for production load)
  connection_timeout_secs: 10 # Timeout for acquiring database connections (faster timeout for production)
  idle_timeout_secs: 300 # Timeout for idle connections before closing (5 minutes)
  enable_wal_mode: true # Enable Write-Ahead Logging for better concurrency and durability
enclaves:
  # AWS Nitro Enclave Configuration
  # ===============================
  # The CID values below are TEMPLATE values only - AWS assigns CIDs dynamically when enclaves start.
  # Manual configuration is required to specify actual AWS-assigned CIDs.
  #
  # REQUIRED: Override with actual AWS-assigned CIDs using environment variables:
  #   KEYMELD_ENCLAVE_0_CID=<actual_cid_assigned_by_aws>
  #   KEYMELD_ENCLAVE_1_CID=<actual_cid_assigned_by_aws>
  #   KEYMELD_ENCLAVE_2_CID=<actual_cid_assigned_by_aws>
  #
  # Deployment workflow:
  # 1. Start AWS Nitro Enclaves using `nitro-cli run-enclave`
  # 2. Capture assigned CIDs from enclave startup output
  # 3. Set environment variables with actual CIDs
  # 4. Start gateway with environment overrides
  #
  # Example deployment script:
  #   CID_0=$(nitro-cli run-enclave --eif-path enclave.eif | grep 'CID:' | cut -d: -f2)
  #   export KEYMELD_ENCLAVE_0_CID=$CID_0
  #   ./keymeld-gateway
  enclaves:
    - id: 0
      cid: 3 # TEMPLATE - Override with KEYMELD_ENCLAVE_0_CID
      port: 8000
    - id: 1
      cid: 4 # TEMPLATE - Override with KEYMELD_ENCLAVE_1_CID
      port: 8000
    - id: 2
      cid: 5 # TEMPLATE - Override with KEYMELD_ENCLAVE_2_CID
      port: 8000
  max_channel_size: 1000 # Internal message buffer size per connection - controls backpressure when requests queue up faster than they can be processed
  vsock_timeout_secs: 300 # Timeout for VSock operations and request/response cycles (5 minutes for crypto operations)
  nonce_generation_timeout_secs: 180 # Timeout for cryptographic nonce generation (3 minutes)
  session_init_timeout_secs: 1800 # Timeout for session initialization (30 minutes for complex key generation)
  signing_timeout_secs: 600 # Timeout for cryptographic signing operations (10 minutes)
  network_write_timeout_secs: 5 # Timeout for individual network write operations
  network_read_timeout_secs: 300 # Timeout for reading crypto operation responses (5 minutes)
  pool_acquire_timeout_secs: 30 # Timeout for acquiring connections from pool (30 seconds in production)
  connection_retry_delay_ms: 100 # Delay between connection retry attempts (100ms)
  max_message_size_bytes: 16777216 # Maximum message size (16MB) for VSock communication
coordinator:
  processing_interval_ms: 100 # How often coordinator processes pending sessions (faster processing for production)
  batch_size: 100 # Number of sessions to process in each batch
  max_retries: 5 # Maximum retry attempts for failed session processing
  processing_timeout_mins: 1 # Timeout for processing individual sessions
logging:
  level: "info" # Log level (info/warn/error for production to reduce noise)
  format: "json" # Log format (json for structured logging in production)
  enable_json: true # Output logs in JSON format for log aggregation systems
  enable_file_output: true # Write logs to file for persistence and rotation
  file_path: "/var/log/keymeld/keymeld.log" # Log file path (ensure directory exists and is writable)
security:
  enable_attestation: true # Enable enclave attestation verification (required for production security)
  strict_validation: true # Enable strict security validation (required for production)
  allow_insecure_connections: false # Forbid non-TLS connections (production security requirement)
  require_tls: true # Require TLS/HTTPS connections (production security requirement)
