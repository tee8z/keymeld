version: "3.8"

services:
  # Bitcoin Core - Regtest blockchain
  bitcoin:
    image: bitcoin/bitcoin:30.0
    container_name: keymeld-bitcoin
    ports:
      - "18443:18443"
    volumes:
      - bitcoin-data:/home/bitcoin/.bitcoin
    command: >
      bitcoind
      -regtest
      -server=1
      -daemon=0
      -rpcbind=0.0.0.0:18443
      -rpcallowip=0.0.0.0/0
      -rpcuser=keymeld
      -rpcpassword=keymeldpass123
      -zmqpubrawblock=tcp://0.0.0.0:28332
      -zmqpubrawtx=tcp://0.0.0.0:28333
      -zmqpubhashtx=tcp://0.0.0.0:28334
      -zmqpubhashblock=tcp://0.0.0.0:28335
      -txindex=1
      -fallbackfee=0.00001
      -minrelaytxfee=0.00001
      -printtoconsole=1
      -debug=net
      -debug=rpc
      -disablewallet=0
      -keypool=100
      -dbcache=512
      -maxconnections=20
      -assumevalid=0
    networks:
      - keymeld-network
    healthcheck:
      test:
        [
          "CMD",
          "bitcoin-cli",
          "-regtest",
          "-rpcuser=keymeld",
          "-rpcpassword=keymeldpass123",
          "getblockchaininfo",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # KeyMeld Gateway - REST API coordinator
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
      network: host
      args:
        ENVIRONMENT: ${KEYMELD_ENV:-dev}
    container_name: keymeld-gateway
    ports:
      - "8080:8080"
    environment:
      - RUST_LOG=info,keymeld_gateway=debug
      - KEYMELD_HOST=0.0.0.0
      - KEYMELD_PORT=8080
      - KEYMELD_DATABASE_PATH=/data/keymeld.db

      - CONFIG_PATH=/app/config/config.yaml
      - TEST_MODE=true
      - ENCLAVE_3_HOST=enclave-0
      - ENCLAVE_4_HOST=enclave-1
      - ENCLAVE_5_HOST=enclave-2

    volumes:
      - ./data:/data
      - ./docker/config/keymeld-regtest.yaml:/app/config.yaml:ro
    networks:
      - keymeld-network
    depends_on:
      enclave-0:
        condition: service_healthy
      enclave-1:
        condition: service_healthy
      enclave-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # KeyMeld Enclave 0
  enclave-0:
    build:
      context: .
      dockerfile: docker/Dockerfile.enclave
      network: host
      args:
        ENVIRONMENT: ${KEYMELD_ENV:-dev}
    container_name: keymeld-enclave-0
    environment:
      - RUST_LOG=info,keymeld_enclave=debug
      - VSOCK_PORT=5000
      - ENCLAVE_ID=0
      - TEST_MODE=true

    ports:
      - "5000:5000"
    networks:
      - keymeld-network

    healthcheck:
      test: ["CMD", "timeout", "3", "bash", "-c", "</dev/tcp/localhost/5000"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # KeyMeld Enclave 1
  enclave-1:
    build:
      context: .
      dockerfile: docker/Dockerfile.enclave
      network: host
      args:
        ENVIRONMENT: ${KEYMELD_ENV:-dev}
    container_name: keymeld-enclave-1
    environment:
      - RUST_LOG=info,keymeld_enclave=debug
      - VSOCK_PORT=5001
      - ENCLAVE_ID=1
      - TEST_MODE=true

    ports:
      - "5001:5001"
    networks:
      - keymeld-network

    healthcheck:
      test: ["CMD", "timeout", "3", "bash", "-c", "</dev/tcp/localhost/5001"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # KeyMeld Enclave 2
  enclave-2:
    build:
      context: .
      dockerfile: docker/Dockerfile.enclave
      network: host
      args:
        ENVIRONMENT: ${KEYMELD_ENV:-dev}
    container_name: keymeld-enclave-2
    environment:
      - RUST_LOG=info,keymeld_enclave=debug
      - VSOCK_PORT=5002
      - ENCLAVE_ID=2
      - TEST_MODE=true

    ports:
      - "5002:5002"
    networks:
      - keymeld-network

    healthcheck:
      test: ["CMD", "timeout", "3", "bash", "-c", "</dev/tcp/localhost/5002"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # KeyMeld Example - Demo application
  example:
    build:
      context: .
      dockerfile: docker/Dockerfile.example
      network: host
      args:
        ENVIRONMENT: ${KEYMELD_ENV:-dev}
    container_name: keymeld-example
    environment:
      - RUST_LOG=info,keymeld_example=debug
      - GATEWAY_URL=http://gateway:8080
      - ESPLORA_URL=http://esplora:3002/api
      - BITCOIN_NETWORK=regtest
      - NUM_SIGNERS=2

    volumes:
      - ./docker/config/example-regtest.yaml:/app/config.yaml:ro
      - /tmp/keymeld-keys:/app/keys
    networks:
      - keymeld-network
    depends_on:
      gateway:
        condition: service_healthy
      enclave-0:
        condition: service_healthy
      enclave-1:
        condition: service_healthy
      enclave-2:
        condition: service_healthy
    profiles:
      - example

volumes:
  bitcoin-data:
    driver: local

networks:
  keymeld-network:
    driver: bridge
